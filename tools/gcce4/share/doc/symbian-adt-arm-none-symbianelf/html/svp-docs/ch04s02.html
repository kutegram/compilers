<html><head><meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"><title>4.2. Virtio_ring</title><link rel="stylesheet" href="cs.css" type="text/css"><meta name="generator" content="DocBook XSL Stylesheets V1.74.0"><link rel="home" href="index.html" title="Symbian ADT Sourcery G++ Lite"><link rel="up" href="chap-virtio.html" title="Chapter 4. Virtio"><link rel="prev" href="chap-virtio.html" title="Chapter 4. Virtio"><link rel="next" href="ch04s03.html" title="4.3. Virtual Platform Bindings"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">4.2. Virtio_ring</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="chap-virtio.html">Prev</a> </td><th width="60%" align="center">Chapter 4. Virtio</th><td width="20%" align="right"> <a accesskey="n" href="ch04s03.html">Next</a></td></tr></table><hr></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="id328996"></a>4.2. Virtio_ring</h2></div></div></div><p>
   SVP devices implement virtqueues using a simple ring buffer interface
   known as virtio_ring.
  </p><p>
   Each virtio_ring consists of 3 parts:  An array of descriptors used to
   implement scatter-gather lists, immediately followed by an avail ring
   used to submit requests to the device.  The used ring allows the device
   to report request completion, and is located starting on the next 4k
   page boundary after the avail ring.
  </p><p>
   The descriptor array and avail ring are managed and written by the guest
   OS driver.  The used ring is written by the device and read by the OS
   driver.
  </p><p>
   The format of a descriptor is as follows:
</p><pre class="programlisting">struct vring_desc
{
  uint64_t addr;
  uint32_t len;
  uint16_t flags;
  uint16_t next;
};</pre><p>
  </p><p>
   The <code class="literal">addr</code> and <code class="literal">len</code> fields identify
   and area of memory.  The next field is used to chain multiple descriptors
   into a single request.  The flags field is a combination of the following
   flags:
   </p><div class="variablelist"><dl><dt><span class="term"><code class="literal">0x0001</code> (Next)</span></dt><dd><p>
       If set then the <code class="literal">next</code> field contains the
       index of the next descriptor for this request.
       If clear then this is the last descriptor in the request.
      </p></dd><dt><span class="term"><code class="literal">0x0002</code> (Write)</span></dt><dd><p>
       If set then this section is to be written by the device.
       If clear then this section is to be read by the device.
      </p></dd></dl></div><p>
  </p><p>
   The format of the avail ring is as follows:
</p><pre class="programlisting">struct vring_avail
{
  uint16_t flags;
  uint16_t idx;
  uint16_t ring[NUM];
};</pre><p>
   The <code class="literal">idx</code> field is a free running index identifying the
   head of the submission queue.  It indexes (with wrapping) into a ring
   of descriptor indexes.  This separation of request submission and
   descriptor management allows the virtqueue to operate in an asynchronous
   manner, and prevents long running requests from blocking short requests.
  </p><p>
   A notification will be generated when the device reads a request from
   the avail ring.  Setting the low bit of the <code class="literal">flags</code>
   field will suppress these notifications.
  </p><p>
   The format of the used ring is as follows:
</p><pre class="programlisting">struct vring_used
{
  uint16_t flags;
  uint16_t idx;
  struct {
    uint16_t id;
    uint16_t len;
  } ring[NUM];
};</pre><p>
   The used ring works much the same way as the the avail ring.  When a
   request completes the index of the first descriptor and the number of
   bytes is written into the next used ring entry, and the
   <code class="literal">idx</code> field is incremented.  The number of bytes
   processed may be less than the total submitted.  e.g. a network device
   may write one packet per request, even if a single request is large
   enough to hold multiple packets.
  </p><p>
   A notification is generated when the device reads a request from
   the avail ring.  Setting the low bit of the <code class="literal">flags</code>
   field suppresses this notifications.
  </p><p>
   To submit a new request the OS driver should first construct a
   descriptor chain for the request. Then it should write the index of
   the first descriptor into the next slot in the avail ring.  Once
   this has been completed the <code class="literal">idx</code> field in the avail
   ring should be incremented.  Finally the device should be notified
   that new requests are available.  Multiple requests may be added before
   performing the notification.
  </p><p>
   When the request completes the device will write write it to the next
   entry in the used ring, then increment the <code class="literal">idx</code> field.
  </p><p>
   Descriptors must not be reused until this has occurred.
   Some devices may process and complete requests out of order.  Provided
   there are unused descriptors available, Additional requests may be
   submitted to the avail ring even if previous requests have not completed.
   Requests can not be cancelled or removed once they have been submitted
   to the device.
  </p><p>
   A notification is generated when a request completes and is added
   to the used ring.  Setting the low bit of the <code class="literal">flags</code>
   field suppresses this notifications.
  </p></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="chap-virtio.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="chap-virtio.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="ch04s03.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Chapter 4. Virtio </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> 4.3. Virtual Platform Bindings</td></tr></table></div></body></html>
